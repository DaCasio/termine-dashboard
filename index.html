<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Termin Monitor - Orbital Control</title>
    <style>
        :root { --accent: #00cae3; --bg-overlay: rgba(0, 0, 0, 0.7); --live-color: #ffcc00; }
        
        body { 
            background: linear-gradient(var(--bg-overlay), var(--bg-overlay)), 
                        url('https://images-assets.nasa.gov/image/PIA08653/PIA08653~medium.jpg');
            background-size: cover; background-attachment: fixed; background-position: center;
            color: white; font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 10px; margin: 0; min-height: 100vh;
        }

        #main-content { width: 100%; max-width: 900px; display: none; position: relative; z-index: 10; }
        
        .card { 
            background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 202, 227, 0.3); border-radius: 12px; 
            padding: 15px; margin-bottom: 20px; box-shadow: 0 0 25px rgba(0,0,0,0.6);
        }

        /* View Toggle */
        .view-toggle { display: flex; gap: 10px; margin-bottom: 20px; width: 100%; justify-content: center; }
        .view-btn { background: rgba(0,0,0,0.5); color: white; border: 1px solid var(--accent); padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; flex: 1; transition: 0.3s; }
        .view-btn.active { background: var(--accent); color: black; }

        /* Calendar Styles */
        #calendar-view { display: none; }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: bold; font-size: 1.2em; color: var(--accent); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .cal-day-label { font-size: 0.7em; color: #777; padding-bottom: 5px; }
        .cal-cell { background: rgba(255,255,255,0.05); min-height: 80px; border-radius: 4px; padding: 4px; font-size: 0.8em; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        .cal-cell.today { border-color: var(--accent); background: rgba(0, 202, 227, 0.1); }
        .cal-cell.other-month { opacity: 0.3; }
        .cal-dot-container { display: flex; flex-direction: column; gap: 2px; margin-top: 4px; }
        .cal-event { background: var(--accent); color: black; font-size: 0.7em; padding: 2px 4px; border-radius: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .cal-event.archived { opacity: 0.5; background: #666; color: white; }

        .input-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .input-row input#t-name { flex: 2; min-width: 250px; }
        .input-row input#t-tags { flex: 1; min-width: 150px; }
        
        .date-group { flex: 3; display: flex; gap: 8px; min-width: 320px; }
        .date-item { flex: 1; display: flex; flex-direction: column; }
        .date-label { font-size: 0.7em; color: var(--accent); text-transform: uppercase; margin-bottom: 4px; font-weight: bold; }
        .required-star { color: #ff4d4d; }

        .toolbar { display: flex; gap: 4px; margin-bottom: 8px; flex-wrap: wrap; align-items: center; }
        .tool-btn { background: #2a2a2a; color: var(--accent); border: 1px solid var(--accent); padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75em; font-weight: bold; }
        .tool-btn:hover { background: var(--accent); color: black; }

        input, textarea { background: rgba(0,0,0,0.6); border: 1px solid #444; color: white; padding: 10px; border-radius: 5px; width: 100%; box-sizing: border-box; margin-bottom: 8px; font-size: 0.95em; }
        textarea { min-height: 80px; font-family: inherit; resize: vertical; }

        .search-container { margin-bottom: 10px; }
        .search-input { border-color: var(--accent); border-style: dashed; background: rgba(0, 202, 227, 0.05); }

        .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; }
        .tag-pill { background: #333; color: #aaa; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; cursor: pointer; border: 1px solid #444; transition: 0.2s; font-weight: bold; }
        .tag-pill.active { background: var(--accent); color: black; border-color: var(--accent); }
        .tag-pill.live-pill { border-color: var(--live-color); color: var(--live-color); }
        .tag-pill.live-pill.active { background: var(--live-color); color: black; }
        .tag-pill.arch-pill { border-color: #666; }

        .termin-counter { text-align: right; font-weight: bold; color: var(--accent); margin-bottom: 10px; font-size: 0.9em; text-transform: uppercase; }

        .termin-card { 
            background: rgba(30,30,30,0.85); backdrop-filter: blur(4px);
            border-left: 6px solid var(--accent); padding: 15px; border-radius: 8px; 
            margin-bottom: 12px; display: flex; flex-direction: column; 
        }

        .row-title { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .titel-box { font-size: 1.3em; font-weight: bold; flex: 1; }
        .actions-box { display: flex; gap: 6px; }

        .tag-display-container { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .tag-mini { font-size: 0.7em; background: rgba(0, 202, 227, 0.2); color: var(--accent); padding: 2px 8px; border-radius: 4px; text-transform: uppercase; border: 1px solid rgba(0, 202, 227, 0.3); }

        .row-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px; }
        .datum-box { font-size: 0.85em; color: #aaa; line-height: 1.4; }
        .countdown-box { 
            background: rgba(0, 202, 227, 0.15); padding: 4px 10px; border-radius: 4px; 
            font-family: 'Courier New', monospace; font-weight: bold; color: var(--accent); 
            font-size: 1.05em; border: 1px solid rgba(0, 202, 227, 0.3); text-align: center; min-width: 140px;
            display: flex; flex-direction: column; justify-content: center;
        }

        .row-notiz { border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 10px; }
        .notiz-display { font-size: 0.95em; line-height: 1.5; color: #ddd; white-space: pre-wrap; word-break: break-word; }

        .btn-main { background: var(--accent); color: black; border: none; padding: 14px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; text-transform: uppercase; margin-top: 10px; }
        .btn-action { padding: 6px 10px; border-radius: 4px; border: none; cursor: pointer; }
        
        .cb-line { cursor: pointer; display: block; padding: 2px 0; }
        .cb-line.done { text-decoration: line-through; color: #777; }
        
        .faellig { color: #ff4d4d !important; border-color: rgba(255, 77, 77, 0.4) !important; background: rgba(255, 77, 77, 0.1) !important; }
        .laufend { color: var(--live-color) !important; border-color: rgba(255, 204, 0, 0.4) !important; background: rgba(255, 204, 0, 0.1) !important; }

        #login-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .logout-btn { background: transparent; color: #ff4d4d; border: 1px solid #ff4d4d; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.7em; float: right; }
        
        @media (max-width: 600px) {
            .date-group { flex-direction: column; min-width: 100%; }
            .cal-cell { min-height: 60px; font-size: 0.7em; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div style="background: #1a1a1a; padding: 30px; border-radius: 15px; border: 1px solid var(--accent); text-align: center;">
            <h2 style="color:var(--accent); margin-top:0;">SYSTEM LOGIN</h2>
            <input type="password" id="pin" placeholder="PIN" style="width:140px; text-align:center; font-size:24px; border: 2px solid var(--accent);">
            <br><button class="btn-main" onclick="login()">ENTER</button>
        </div>
    </div>

    <div id="main-content">
        <button class="logout-btn" onclick="logout()">LOGOUT</button>
        <h1 style="text-align:center; text-transform:uppercase; letter-spacing:5px; margin-bottom:20px;">Termin Monitor</h1>
        
        <div class="view-toggle">
            <button id="btn-list" class="view-btn active" onclick="switchView('list')">MONITOR</button>
            <button id="btn-cal" class="view-btn" onclick="switchView('cal')">KALENDER</button>
        </div>

        <div class="card">
            <input type="hidden" id="edit-id" value="-1">
            
            <div class="input-row">
                <input type="text" id="t-name" placeholder="Titel des Termins">
                <input type="text" id="t-tags" placeholder="Tags (z.B. ARCHIV, Arbeit...)">
                <div class="date-group">
                    <div class="date-item">
                        <span class="date-label">Start (Optional)</span>
                        <input type="datetime-local" id="t-start">
                    </div>
                    <div class="date-item">
                        <span class="date-label">F√§lligkeit / Ende <span class="required-star">*</span></span>
                        <input type="datetime-local" id="t-date">
                    </div>
                </div>
            </div>
            
            <div class="toolbar">
                <button class="tool-btn" onclick="wrapText('**','**')">B</button>
                <button class="tool-btn" onclick="wrapText('--','--')">S</button>
                <button class="tool-btn" onclick="wrapText('[color:#ff4d4d]','[/color]')" style="color:#ff4d4d">ROT</button>
                <button class="tool-btn" onclick="wrapText('[color:#00ff00]','[/color]')" style="color:#00ff00">GR√úN</button>
                <button class="tool-btn" onclick="wrapText('[color:#ffff00]','[/color]')" style="color:#ffff00">GELB</button>
                <button class="tool-btn" onclick="wrapText('[color:#00cae3]','[/color]')" style="color:#00cae3">BLAU</button>
                <button class="tool-btn" onclick="addCB()">+ CHECKBOX</button>
                <button class="tool-btn" onclick="document.getElementById('ics-upload').click()">+ ICS IMPORT</button>
                <input type="file" id="ics-upload" accept=".ics" style="display:none" onchange="importICS(this)">
            </div>
            
            <textarea id="t-note" placeholder="Notizen..."></textarea>
            <div id="cb-list" style="margin-bottom: 8px;"></div>
            <button class="btn-main" id="save-btn" onclick="save()">TERMIN SPEICHERN</button>
        </div>

        <div id="list-view">
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="üîç Termin oder Inhalt suchen..." oninput="render()">
            </div>
            <div id="filter-display" class="filter-bar"></div>
            <div id="counter-display" class="termin-counter">AKTIVE TERMINE: 0</div>
            <div id="liste">Lade Daten aus Orbit...</div>
        </div>

        <div id="calendar-view" class="card">
            <div class="cal-header">
                <button class="tool-btn" onclick="changeMonth(-1)">‚óÄ</button>
                <span id="cal-month-title">Monat Jahr</span>
                <button class="tool-btn" onclick="changeMonth(1)">‚ñ∂</button>
            </div>
            <div class="cal-grid" id="cal-grid"></div>
        </div>
    </div>

<script>
    const P_ENC = "MDUwOA==";
    const t1 = "github_pat_11BBRVHCQ05kX9OEirDuF2";
    const t2 = "_SfPbmFFMu5S4O8kX6AdanuVfPsNY6k84nVv35qdNOgAV5OKWJ5NnW3tS9qH";
    const G_URL = 'https://api.github.com/repos/dacasio/info-board/contents/termine.json';
    let data = [], currentSha = "", isLogged = false, activeFilter = "ALL";
    let calDate = new Date();

    window.onload = () => { if(localStorage.getItem('termin_monitor_auth') === 'true') login(true); };

    function login(auto = false) {
         const pinField = document.getElementById('pin');
         if(auto || (pinField.value && btoa(pinField.value) === P_ENC)) {
            localStorage.setItem('termin_monitor_auth', 'true');
            document.getElementById('login-overlay').style.display='none';
            document.getElementById('main-content').style.display='block';
            isLogged = true; load();
         } else if(!auto) { alert("PIN inkorrekt."); }
    }

    function logout() { localStorage.removeItem('termin_monitor_auth'); location.reload(); }

    async function load() {
        try {
            const res = await fetch(G_URL, { headers: { 'Authorization': `token ${t1+t2}` }, cache: "no-store" });
            if(res.ok) {
                const j = await res.json();
                currentSha = j.sha;
                data = JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(j.content), c => c.charCodeAt(0))));
                render();
            }
        } catch(e) { console.error("Sync-Fehler", e); }
    }

    function switchView(view) {
        document.getElementById('list-view').style.display = view === 'list' ? 'block' : 'none';
        document.getElementById('calendar-view').style.display = view === 'cal' ? 'block' : 'none';
        document.getElementById('btn-list').classList.toggle('active', view === 'list');
        document.getElementById('btn-cal').classList.toggle('active', view === 'cal');
        if(view === 'cal') renderCalendar();
    }

    function changeMonth(dir) {
        calDate.setMonth(calDate.getMonth() + dir);
        renderCalendar();
    }

    function renderCalendar() {
        const grid = document.getElementById('cal-grid');
        const title = document.getElementById('cal-month-title');
        grid.innerHTML = "";
        
        const year = calDate.getFullYear();
        const month = calDate.getMonth();
        title.innerText = new Intl.DateTimeFormat('de-DE', { month: 'long', year: 'numeric' }).format(calDate);

        ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"].forEach(d => {
            grid.innerHTML += `<div class="cal-day-label">${d}</div>`;
        });

        const firstDay = (new Date(year, month, 1).getDay() + 6) % 7;
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDay - 1; i >= 0; i--) {
            createCalCell(grid, daysInPrevMonth - i, true);
        }

        for (let d = 1; d <= daysInMonth; d++) {
            const isToday = d === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear();
            createCalCell(grid, d, false, isToday, year, month);
        }

        const totalCells = grid.children.length - 7;
        const remaining = (42 - totalCells) % 42;
        for (let i = 1; i <= remaining; i++) {
            createCalCell(grid, i, true);
        }
    }

    function createCalCell(container, day, otherMonth, isToday, year, month) {
        const cell = document.createElement('div');
        cell.className = `cal-cell ${otherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}`;
        cell.innerHTML = `<b>${day}</b><div class="cal-dot-container"></div>`;
        
        if (!otherMonth) {
            const cellDateStr = `${year}-${(month+1).toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
            const events = data.filter(t => t.ziel.startsWith(cellDateStr));
            const dotContainer = cell.querySelector('.cal-dot-container');
            
            events.forEach(t => {
                const isArchived = t.tags && t.tags.includes("ARCHIV");
                const evDiv = document.createElement('div');
                evDiv.className = `cal-event ${isArchived ? 'archived' : ''}`;
                evDiv.innerText = t.name;
                evDiv.onclick = (e) => {
                    e.stopPropagation();
                    edit(data.indexOf(t));
                    switchView('list');
                };
                dotContainer.appendChild(evDiv);
            });
        }
        container.appendChild(cell);
    }

    function getCountdown(ms) {
        if (ms < 0) return null;
        const d = Math.floor(ms/86400000).toString().padStart(2,'0');
        const hh = Math.floor((ms%86400000)/3600000).toString().padStart(2,'0');
        const mm = Math.floor((ms%3600000)/60000).toString().padStart(2,'0');
        const ss = Math.floor((ms%60000)/1000).toString().padStart(2,'0');
        return `${d}d ${hh}:${mm}:${ss}`;
    }

    function render() {
        const jetzt = new Date();
        const searchQuery = document.getElementById('search-input').value.toLowerCase();
        let filteredData;
        
        if (activeFilter === "ALL") {
            filteredData = data.filter(t => !t.tags || !t.tags.includes("ARCHIV"));
        } else if (activeFilter === "ARCHIV") {
            filteredData = data.filter(t => t.tags && t.tags.includes("ARCHIV"));
        } else if (activeFilter === "LIVE") {
            filteredData = data.filter(t => {
                const s = t.start ? new Date(t.start) : null;
                const z = new Date(t.ziel);
                return s && jetzt >= s && jetzt <= z;
            });
        } else {
            filteredData = data.filter(t => t.tags && t.tags.includes(activeFilter));
        }

        if (searchQuery) {
            filteredData = filteredData.filter(t => 
                t.name.toLowerCase().includes(searchQuery) || 
                (t.notiz && t.notiz.toLowerCase().includes(searchQuery))
            );
        }

        document.getElementById('counter-display').innerText = `${activeFilter} TERMINE: ${filteredData.length}`;
        updateFilterBar();
        if(document.getElementById('calendar-view').style.display === 'block') renderCalendar();

        filteredData.sort((a, b) => {
            const zielA = new Date(a.ziel), startA = a.start ? new Date(a.start) : null;
            const zielB = new Date(b.ziel), startB = b.start ? new Date(b.start) : null;
            const relevantA = (startA && jetzt < startA) ? startA : zielA;
            const relevantB = (startB && jetzt < startB) ? startB : zielB;
            return relevantA - relevantB;
        });

        let h = "";
        filteredData.forEach((t) => {
            const originalIndex = data.indexOf(t);
            const ziel = new Date(t.ziel), start = t.start ? new Date(t.start) : null;
            let statusText = "F√ÑLLIG", displayTime = "", cssClass = "faellig";

            if (start && jetzt < start) {
                statusText = "START IN";
                displayTime = getCountdown(start - jetzt);
                cssClass = ""; 
            } else if (jetzt < ziel) {
                statusText = start ? "ENDE IN" : "";
                displayTime = getCountdown(ziel - jetzt);
                cssClass = start ? "laufend" : ""; 
            } else {
                statusText = ""; 
                displayTime = "F√ÑLLIG"; 
                cssClass = "faellig";
            }

            const tagsHtml = t.tags ? t.tags.map(tag => `<span class="tag-mini">${tag}</span>`).join('') : '';
            const optionsFull = { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
            const optionsNoYear = { weekday: 'short', day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' };
            const showStartYear = start && ziel && start.getFullYear() !== ziel.getFullYear();
            const startStr = start ? `Start: ${start.toLocaleString('de-DE', showStartYear ? optionsFull : optionsNoYear)} Uhr<br>` : '';
            const zielStr = `Ende: ${ziel.toLocaleString('de-DE', optionsFull)} Uhr`;
            const timeStyle = displayTime === "F√ÑLLIG" ? "font-size: 1.2em; padding: 10px 0;" : "";

            h += `
            <div class="termin-card">
                <div class="row-title">
                    <div class="titel-box">${t.name}</div>
                    <div class="actions-box">
                        <button class="btn-action" style="background:#00cae3" onclick="copy(${originalIndex})">üìÑ</button>
                        <button class="btn-action" style="background:#ffcc00" onclick="edit(${originalIndex})">‚úé</button>
                        <button class="btn-action" style="background:#ff4d4d; color:white" onclick="del(${originalIndex})">‚úï</button>
                    </div>
                </div>
                <div class="tag-display-container">${tagsHtml}</div>
                <div class="row-info">
                    <div class="datum-box">${startStr}${zielStr}</div>
                    <div class="countdown-box ${cssClass}" style="${timeStyle}">
                        ${statusText ? `<small style="font-size:0.6em; display:block;">${statusText}</small>` : ''}
                        ${displayTime}
                    </div>
                </div>
                <div class="row-notiz"><div class="notiz-display">${format(t.notiz, originalIndex)}</div></div>
            </div>`;
        });
        document.getElementById('liste').innerHTML = h || "<p style='text-align:center;'>Keine Termine gefunden!</p>";
    }

    function updateFilterBar() {
        const jetzt = new Date();
        const allTags = new Set();
        let hasLive = false;
        data.forEach(t => { 
            if(t.tags) t.tags.forEach(tag => allTags.add(tag)); 
            const s = t.start ? new Date(t.start) : null;
            const z = new Date(t.ziel);
            if(s && jetzt >= s && jetzt <= z) hasLive = true;
        });
        let fHtml = `<span class="tag-pill ${activeFilter === 'ALL' ? 'active' : ''}" onclick="setFilter('ALL')">ALLE</span>`;
        if(hasLive) fHtml += `<span class="tag-pill live-pill ${activeFilter === 'LIVE' ? 'active' : ''}" onclick="setFilter('LIVE')">‚óè LIVE NOW</span>`;
        allTags.forEach(tag => {
            if(tag !== "ARCHIV") fHtml += `<span class="tag-pill ${activeFilter === tag ? 'active' : ''}" onclick="setFilter('${tag}')">${tag}</span>`;
        });
        if(allTags.has("ARCHIV")) fHtml += `<span class="tag-pill arch-pill ${activeFilter === 'ARCHIV' ? 'active' : ''}" onclick="setFilter('ARCHIV')">üìÅ ARCHIV</span>`;
        document.getElementById('filter-display').innerHTML = fHtml;
    }

    function setFilter(tag) { activeFilter = tag; render(); }

    function format(txt, tIdx) {
        if(!txt) return "";
        let lines = txt.split('\n').map((l, lIdx) => {
            if(l.startsWith('[ ]')) return `<span class="cb-line" onclick="toggle(${tIdx},${lIdx})">‚òê ${l.slice(3)}</span>`;
            if(l.startsWith('[x]')) return `<span class="cb-line done" onclick="toggle(${tIdx},${lIdx})">‚òë ${l.slice(3)}</span>`;
            return l;
        });
        return lines.join('\n').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/--(.*?)--/g, '<s>$1</s>').replace(/\[color:(.*?)\](.*?)\[\/color\]/g, '<span style="color:$1">$2</span>');
    }

    async function toggle(tIdx, lIdx) {
        let l = data[tIdx].notiz.split('\n');
        l[lIdx] = l[lIdx].startsWith('[ ]') ? l[lIdx].replace('[ ]','[x]') : l[lIdx].replace('[x]','[ ]');
        data[tIdx].notiz = l.join('\n');
        saveToGit();
    }

    function addCB(val = "", checked = false) {
        const div = document.createElement('div');
        div.className = "cb-edit-row";
        div.style = "display:flex; gap:5px; margin-bottom:5px;";
        div.innerHTML = `<input type="checkbox" ${checked ? 'checked' : ''} style="width:20px; margin:0;"><input type="text" value="${val}" style="flex:1; margin-bottom:0;"><button class="tool-btn" onclick="this.parentElement.remove()">‚úï</button>`;
        document.getElementById('cb-list').appendChild(div);
    }

    function edit(i) {
        const t = data[i];
        document.getElementById('edit-id').value = i;
        document.getElementById('t-name').value = t.name;
        document.getElementById('t-tags').value = t.tags ? t.tags.join(', ') : '';
        document.getElementById('t-start').value = t.start ? t.start.substring(0,16) : '';
        document.getElementById('t-date').value = t.ziel.substring(0,16);
        document.getElementById('cb-list').innerHTML = "";
        let textPart = [];
        t.notiz.split('\n').forEach(line => {
            if(line.startsWith('[ ]')) addCB(line.slice(3), false);
            else if(line.startsWith('[x]')) addCB(line.slice(3), true);
            else textPart.push(line);
        });
        document.getElementById('t-note').value = textPart.join('\n');
        document.getElementById('save-btn').innerText = "√Ñnderung Speichern";
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function copy(i) { edit(i); document.getElementById('edit-id').value = "-1"; document.getElementById('t-name').value += " (Kopie)"; }

    async function save() {
        const saveBtn = document.getElementById('save-btn');
        const name = document.getElementById('t-name').value, 
              ziel = document.getElementById('t-date').value, 
              start = document.getElementById('t-start').value,
              note = document.getElementById('t-note').value, 
              tagsRaw = document.getElementById('t-tags').value,
              id = document.getElementById('edit-id').value;
        if(!name || !ziel) { alert("Bitte Titel und Enddatum angeben."); return; }
        saveBtn.disabled = true;
        saveBtn.innerText = "SYNCHRONISIERE...";
        const tags = tagsRaw.split(',').map(s => s.trim().toUpperCase()).filter(s => s !== "");
        let fullNote = note;
        document.querySelectorAll('.cb-edit-row').forEach(row => {
            const txt = row.querySelector('input[type="text"]').value, chk = row.querySelector('input[type="checkbox"]').checked;
            if(txt) fullNote += `\n${chk ? '[x]' : '[ ]'}${txt}`;
        });
        const entry = { name, start: start || null, ziel, notiz: fullNote.trim(), tags };
        if(id === "-1") data.push(entry); else data[id] = entry;
        await saveToGit();
        resetForm();
        saveBtn.disabled = false;
    }

    function resetForm() {
        document.getElementById('edit-id').value = "-1"; 
        document.getElementById('cb-list').innerHTML = ""; 
        document.getElementById('t-note').value = ""; 
        document.getElementById('t-name').value = "";
        document.getElementById('t-tags').value = "";
        document.getElementById('t-start').value = "";
        document.getElementById('t-date').value = "";
        document.getElementById('save-btn').innerText = "TERMIN SPEICHERN";
    }

    async function saveToGit() {
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 4))));
        try {
            const res = await fetch(G_URL, { 
                method: 'PUT', 
                headers: { 'Authorization': `token ${t1+t2}`, 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ message: "Update via Monitor", content, sha: currentSha }) 
            });
            if (res.ok) {
                const j = await res.json();
                currentSha = j.content.sha;
                render();
            }
        } catch(e) { alert("Fehler beim Speichern im Orbit."); }
    }

    function importICS(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            const summary = content.match(/SUMMARY:(.*)/)?.[1] || "ICS Import";
            const dtStartMatch = content.match(/DTSTART[:;](?:VALUE=DATE:)?(\d{8}T\d{6}|\d{8})/);
            const dtEndMatch = content.match(/DTEND[:;](?:VALUE=DATE:)?(\d{8}T\d{6}|\d{8})/);
            const parseDate = (match) => {
                if (!match) return "";
                const d = match[1];
                return `${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}T${d.slice(9,11) || '00'}:${d.slice(11,13) || '00'}`;
            };
            document.getElementById('t-name').value = summary.trim();
            document.getElementById('t-start').value = parseDate(dtStartMatch);
            document.getElementById('t-date').value = parseDate(dtEndMatch);
            alert("ICS Daten geladen. Bitte pr√ºfen und speichern.");
        };
        reader.readAsText(file);
    }

    function del(i) { if(confirm("L√∂schen?")) { data.splice(i,1); saveToGit(); } }
    function wrapText(b, a) { const t = document.getElementById('t-note'); const s = t.selectionStart, e = t.selectionEnd; t.value = t.value.substring(0,s)+b+t.value.substring(s,e)+a+t.value.substring(e); t.focus(); }

    setInterval(() => { if(isLogged) render(); }, 1000);
    setInterval(() => { if(isLogged) load(); }, 60000);
</script>
</body>
</html>
