<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Termin Monitor - Secure</title>
    <style>
        body { 
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), 
                        url('https://images-assets.nasa.gov/image/PIA08653/PIA08653~medium.jpg');
            background-size: cover; background-attachment: fixed; background-position: center;
            color: white; font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 20px; margin: 0; min-height: 100vh;
        }

        /* PIN Login Overlay */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(20px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; transition: 0.5s;
        }
        .pin-input { 
            padding: 15px; font-size: 24px; text-align: center; border-radius: 10px; 
            border: 2px solid #00cae3; background: black; color: white; width: 150px; margin-bottom: 20px;
        }

        h1 { border-bottom: 3px solid #00cae3; padding-bottom: 10px; text-transform: uppercase; letter-spacing: 5px; text-shadow: 0 0 10px rgba(0, 202, 227, 0.5); text-align: center; }
        .input-box { background: rgba(26, 26, 26, 0.8); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; margin-bottom: 30px; width: 100%; max-width: 850px; display: flex; gap: 10px; flex-wrap: wrap; border: 1px solid rgba(255, 255, 255, 0.1); box-sizing: border-box; }
        input { padding: 10px; border-radius: 5px; border: 1px solid #444; background: rgba(0, 0, 0, 0.5); color: white; flex: 1; min-width: 150px; }
        .add-btn { padding: 10px 25px; border-radius: 5px; border: none; background: #00cae3; color: black; font-weight: bold; cursor: pointer; }
        #liste { width: 100%; max-width: 850px; }
        .termin-card { background: rgba(30, 30, 30, 0.7); backdrop-filter: blur(5px); margin: 10px 0; padding: 15px 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 8px solid #00cae3; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); }
        .zeit { color: #00cae3; font-family: 'Courier New', monospace; font-size: 1.5em; font-weight: bold; }
        .action-btn { border: none; border-radius: 5px; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .del-btn { background: rgba(255, 77, 77, 0.8); color: white; }
        .edit-btn { background: rgba(243, 156, 18, 0.8); color: white; }

        @media (max-width: 600px) {
            .termin-card { flex-direction: column; align-items: flex-start; }
            .zeit { font-size: 1.2em; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <h2 style="letter-spacing: 3px;">ZUGRIFF GESPERRT</h2>
        <input type="password" id="pin-field" class="pin-input" placeholder="PIN" inputmode="numeric" maxlength="4">
        <button class="add-btn" onclick="checkPin()">ENTRIEGELN</button>
    </div>

    <h1>Termin Monitor</h1>

    <div class="input-box">
        <input type="text" id="new-name" placeholder="Neuer Termin...">
        <input type="datetime-local" id="new-date">
        <button class="add-btn" onclick="speichereTermin()">Hinzufügen</button>
    </div>

    <div id="liste">Warte auf Freigabe...</div>

    <script>
        // DEINE PIN - Hier kannst du sie ändern
        const RICHTIGE_PIN = "0508"; 

        // Dein bewährter Token-Trick
        const p1 = "github_pat_11BBRVHCQ0";
        const p2 = "kfCkR2kerggY_CIMB62HxreVC5u9vtrAxSaXpoG0pqljhfY8IkeF8lopZROR2OSU5IQ1EIs9";
        const GITHUB_TOKEN = p1 + p2;
        const GITHUB_URL = 'https://api.github.com/repos/dacasio/info-board/contents/termine.json';

        let termineDaten = [];
        let currentSha = "";

        // PIN Logik
        function checkPin() {
            const eingabe = document.getElementById('pin-field').value;
            if (eingabe === RICHTIGE_PIN) {
                document.getElementById('login-overlay').style.display = 'none';
                localStorage.setItem('monitor_auth', Date.now()); // Login merken
                holeDaten();
            } else {
                alert("Falscher Code!");
                document.getElementById('pin-field').value = "";
            }
        }

        // Automatisch einloggen, wenn vor kurzem erst eingegeben
        window.onload = () => {
            const lastAuth = localStorage.getItem('monitor_auth');
            if (lastAuth && (Date.now() - lastAuth < 86400000)) { // 24h gültig
                document.getElementById('login-overlay').style.display = 'none';
                holeDaten();
            }
        };

        async function holeDaten() {
            try {
                const response = await fetch(GITHUB_URL, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } });
                if (response.ok) {
                    const data = await response.json();
                    currentSha = data.sha;
                    termineDaten = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                    termineDaten.sort((a, b) => new Date(a.ziel) - new Date(b.ziel));
                    updateAnzeige();
                }
            } catch (e) { console.error(e); }
        }

        async function pushToGithub(neueListe, msg) {
            const newContent = btoa(unescape(encodeURIComponent(JSON.stringify(neueListe, null, 4))));
            await fetch(GITHUB_URL, {
                method: 'PUT',
                headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg, content: newContent, sha: currentSha })
            });
            holeDaten();
        }

        function speichereTermin() {
            const n = document.getElementById('new-name'), d = document.getElementById('new-date');
            if (!n.value || !d.value) return;
            pushToGithub([...termineDaten, { "name": n.value, "ziel": d.value + ":00" }], "Neu: " + n.value);
            n.value = ''; d.value = '';
        }

        function loescheTermin(i) { if (confirm("Löschen?")) pushToGithub(termineDaten.filter((_, idx) => idx !== i), "Gelöscht"); }

        function updateAnzeige() {
            const listeDiv = document.getElementById('liste');
            listeDiv.innerHTML = '';
            const jetzt = new Date();
            termineDaten.forEach((t, index) => {
                const ziel = new Date(t.ziel), diff = ziel - jetzt;
                let zeitStr = "Fällig", statusClass = "erledigt";
                if (diff > 0) {
                    const d = Math.floor(diff/86400000), h = Math.floor((diff%86400000)/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
                    zeitStr = `${d}t ${h}h ${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
                    statusClass = diff < 86400000 ? "warn-red" : (diff < 259200000 ? "warn-yellow" : "");
                }
                const card = document.createElement('div');
                card.className = `termin-card ${statusClass}`;
                card.innerHTML = `<div class="info-bereich"><span class="name">${t.name}</span><br><small>Ziel: ${new Date(t.ziel).toLocaleString()}</small></div>
                    <div style="display:flex; align-items:center; gap:10px;"><span class="zeit">${zeitStr}</span><button class="action-btn del-btn" onclick="loescheTermin(${index})">✕</button></div>`;
                listeDiv.appendChild(card);
            });
        }

        setInterval(updateAnzeige, 1000);
        setInterval(() => { if(document.getElementById('login-overlay').style.display === 'none') holeDaten(); }, 60000);
    </script>
</body>
</html>
