<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Termin Monitor - Pro Control</title>
    <style>
        :root { --accent: #00cae3; --bg: #121212; }
        body { 
            background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://images-assets.nasa.gov/image/PIA08653/PIA08653~medium.jpg');
            background-size: cover; background-attachment: fixed; color: white; font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0;
        }

        #main-content { width: 100%; max-width: 900px; display: none; }
        .card { background: rgba(20, 20, 20, 0.9); border: 1px solid rgba(0, 202, 227, 0.3); border-radius: 15px; padding: 25px; margin-bottom: 30px; }
        
        /* Toolbar Styling */
        .toolbar { display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap; }
        .tool-btn { background: #333; color: var(--accent); border: 1px solid var(--accent); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        .tool-btn:hover { background: var(--accent); color: black; }

        input, textarea { background: rgba(0,0,0,0.5); border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; margin-bottom: 15px; }
        textarea { min-height: 80px; font-family: monospace; }

        /* Checkbox Editor Bereich */
        #cb-editor-zone { border: 1px dashed #555; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: rgba(0,0,0,0.3); }
        .cb-edit-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
        .cb-edit-row input[type="text"] { margin-bottom: 0; }

        .btn-main { background: var(--accent); color: black; border: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1.1em; }
        
        .termin-card { background: rgba(30,30,30,0.8); border-left: 10px solid var(--accent); padding: 20px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; }
        .notiz-display { margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; font-size: 0.95em; white-space: pre-wrap; }
        .cb-line { cursor: pointer; display: block; padding: 2px 0; }
        .cb-line.done { text-decoration: line-through; color: #777; }
        
        /* Login */
        #login-overlay { position: fixed; inset: 0; background: black; display: flex; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div style="text-align:center">
            <input type="password" id="pin" placeholder="PIN" style="width:100px; text-align:center; font-size:20px;">
            <br><button class="btn-main" onclick="login()">LOGIN</button>
        </div>
    </div>

    <div id="main-content">
        <div class="card">
            <h2>Neuer / Edit Termin</h2>
            <input type="hidden" id="edit-id" value="">
            <input type="text" id="t-name" placeholder="Titel">
            <input type="datetime-local" id="t-date">
            
            <div class="toolbar">
                <button class="tool-btn" onclick="wrapText('**','**')"><b>Fett</b></button>
                <button class="tool-btn" onclick="wrapText('--','--')"><del>Durch</del></button>
                <button class="tool-btn" onclick="wrapText('[color:red]','[/color]')">Rot</button>
                <button class="tool-btn" onclick="wrapText('[color:green]','[/color]')">Grün</button>
                <button class="tool-btn" onclick="addCB()">+ Checkbox</button>
            </div>
            <textarea id="t-note" placeholder="Notizentext..."></textarea>

            <div id="cb-editor-zone">
                <small style="color:var(--accent)">Checklisten-Editor:</small>
                <div id="cb-list"></div>
            </div>

            <button class="btn-main" id="save-btn" onclick="save()">TERMIN SPEICHERN</button>
        </div>

        <div id="liste"></div>
    </div>

<script>
    const t1 = "github_pat_11BBRVHCQ05kX9OEirDuF2";
    const t2 = "_SfPbmFFMu5S4O8kX6AdanuVfPsNY6k84nVv35qdNOgAV5OKWJ5NnW3tS9qH";
    const G_URL = 'https://api.github.com/repos/dacasio/info-board/contents/termine.json';
    let data = [], currentSha = "";

    function login() {
        if(btoa(document.getElementById('pin').value) === "MDUwOA==") {
            document.getElementById('login-overlay').style.display='none';
            document.getElementById('main-content').style.display='block';
            load();
        }
    }

    // Textformatierung per Button
    function wrapText(before, after) {
        const area = document.getElementById('t-note');
        const start = area.selectionStart;
        const end = area.selectionEnd;
        const text = area.value;
        area.value = text.substring(0, start) + before + text.substring(start, end) + after + text.substring(end);
        area.focus();
    }

    // Checkboxen unter dem Feld verwalten
    function addCB(val = "", checked = false) {
        const div = document.createElement('div');
        div.className = "cb-edit-row";
        div.innerHTML = `
            <input type="checkbox" ${checked ? 'checked' : ''}>
            <input type="text" value="${val}" placeholder="Aufgabe...">
            <button class="tool-btn" style="border-color:red; color:red" onclick="this.parentElement.remove()">X</button>
        `;
        document.getElementById('cb-list').appendChild(div);
    }

    async function load() {
        const res = await fetch(G_URL, { headers: { 'Authorization': `token ${t1+t2}` } });
        if(res.ok) {
            const j = await res.json();
            currentSha = j.sha;
            data = JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(j.content), c => c.charCodeAt(0))));
            render();
        }
    }

    function render() {
        let h = "";
        data.sort((a,b) => new Date(a.ziel) - new Date(b.ziel)).forEach((t, i) => {
            h += `
                <div class="termin-card">
                    <div style="flex:1">
                        <strong style="font-size:1.2em">${t.name}</strong><br>
                        <small>${new Date(t.ziel).toLocaleString()}</small>
                        <div class="notiz-display">${format(t.notiz, i)}</div>
                    </div>
                    <div>
                        <button class="tool-btn" onclick="edit(${i})">EDIT</button>
                        <button class="tool-btn" style="color:red" onclick="del(${i})">DEL</button>
                    </div>
                </div>`;
        });
        document.getElementById('liste').innerHTML = h;
    }

    function format(txt, tIdx) {
        if(!txt) return "";
        let lines = txt.split('\n').map((l, lIdx) => {
            if(l.startsWith('[ ]')) return `<span class="cb-line" onclick="toggle(${tIdx},${lIdx})">☐ ${l.slice(3)}</span>`;
            if(l.startsWith('[x]')) return `<span class="cb-line done" onclick="toggle(${tIdx},${lIdx})">☑ ${l.slice(3)}</span>`;
            return l;
        });
        return lines.join('\n').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
            .replace(/--(.*?)--/g, '<s>$1</s>')
            .replace(/\[color:(.*?)\](.*?)\[\/color\]/g, '<span style="color:$1">$2</span>');
    }

    async function toggle(tIdx, lIdx) {
        let l = data[tIdx].notiz.split('\n');
        l[lIdx] = l[lIdx].startsWith('[ ]') ? l[lIdx].replace('[ ]','[x]') : l[lIdx].replace('[x]','[ ]');
        data[tIdx].notiz = l.join('\n');
        saveToGit();
    }

    function edit(i) {
        const t = data[i];
        document.getElementById('edit-id').value = i;
        document.getElementById('t-name').value = t.name;
        document.getElementById('t-date').value = t.ziel.substring(0,16);
        document.getElementById('cb-list').innerHTML = "";
        
        let textPart = [];
        t.notiz.split('\n').forEach(line => {
            if(line.startsWith('[ ]')) addCB(line.slice(3), false);
            else if(line.startsWith('[x]')) addCB(line.slice(3), true);
            else textPart.push(line);
        });
        document.getElementById('t-note').value = textPart.join('\n');
        window.scrollTo(0,0);
    }

    async function save() {
        const name = document.getElementById('t-name').value;
        const date = document.getElementById('t-date').value;
        const note = document.getElementById('t-note').value;
        const id = document.getElementById('edit-id').value;
        
        let fullNote = note;
        document.querySelectorAll('.cb-edit-row').forEach(row => {
            const txt = row.querySelector('input[type="text"]').value;
            const chk = row.querySelector('input[type="checkbox"]').checked;
            if(txt) fullNote += `\n${chk ? '[x]' : '[ ]'}${txt}`;
        });

        const entry = { name, ziel: date, notiz: fullNote.trim() };
        if(id === "") data.push(entry); else data[id] = entry;
        saveToGit();
        // Reset
        document.getElementById('edit-id').value = "";
        document.getElementById('cb-list').innerHTML = "";
        document.getElementById('t-note').value = "";
    }

    async function saveToGit() {
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 4))));
        await fetch(G_URL, {
            method: 'PUT',
            headers: { 'Authorization': `token ${t1+t2}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: "Update", content, sha: currentSha })
        });
        load();
    }

    function del(i) { if(confirm("Löschen?")) { data.splice(i,1); saveToGit(); } }
</script>
</body>
</html>
