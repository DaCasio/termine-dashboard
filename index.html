<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Termin Monitor - Orbital Control</title>
    <style>
        :root { --accent: #00cae3; --bg-overlay: rgba(0, 0, 0, 0.7); }
        
        body { 
            background: linear-gradient(var(--bg-overlay), var(--bg-overlay)), 
                        url('https://images-assets.nasa.gov/image/PIA08653/PIA08653~medium.jpg');
            background-size: cover; background-attachment: fixed; background-position: center;
            color: white; font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 10px; margin: 0; min-height: 100vh;
        }

        #main-content { width: 100%; max-width: 850px; display: none; position: relative; z-index: 10; }
        
        .card { 
            background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 202, 227, 0.3); border-radius: 12px; 
            padding: 15px; margin-bottom: 20px; box-shadow: 0 0 25px rgba(0,0,0,0.6);
        }
        
        .toolbar { display: flex; gap: 4px; margin-bottom: 8px; flex-wrap: wrap; }
        .tool-btn { background: #2a2a2a; color: var(--accent); border: 1px solid var(--accent); padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75em; font-weight: bold; }
        .tool-btn:hover { background: var(--accent); color: black; }

        input, textarea, select { background: rgba(0,0,0,0.6); border: 1px solid #444; color: white; padding: 10px; border-radius: 5px; width: 100%; box-sizing: border-box; margin-bottom: 8px; font-size: 0.95em; }
        textarea { min-height: 80px; font-family: inherit; resize: vertical; }

        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .tag-pill { background: #333; padding: 4px 10px; border-radius: 20px; font-size: 0.75em; cursor: pointer; border: 1px solid #555; transition: 0.3s; }
        .tag-pill.active { background: var(--accent); color: black; border-color: var(--accent); }

        .termin-card { 
            background: rgba(30,30,30,0.85); backdrop-filter: blur(4px);
            border-left: 6px solid var(--accent); padding: 15px; border-radius: 8px; 
            margin-bottom: 12px; display: flex; flex-direction: column; 
        }

        .tag-container { display: flex; gap: 5px; margin-top: 8px; flex-wrap: wrap; }
        .tag { font-size: 0.7em; background: rgba(0, 202, 227, 0.2); color: var(--accent); padding: 2px 8px; border-radius: 4px; text-transform: uppercase; }

        .btn-main { background: var(--accent); color: black; border: none; padding: 14px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1em; text-transform: uppercase; margin-top: 10px; }
        .btn-action { padding: 6px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.9em; }
        
        #login-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .logout-btn { background: transparent; color: #ff4d4d; border: 1px solid #ff4d4d; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.7em; float: right; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div style="background: #1a1a1a; padding: 30px; border-radius: 15px; border: 1px solid var(--accent); text-align: center;">
            <h2 style="color:var(--accent); margin-top:0;">SYSTEM LOGIN</h2>
            <input type="password" id="pin" placeholder="PIN" style="width:140px; text-align:center; font-size:24px; border: 2px solid var(--accent);">
            <br><button class="btn-main" onclick="login()">ENTER</button>
        </div>
    </div>

    <div id="main-content">
        <button class="logout-btn" onclick="logout()">LOGOUT</button>
        <h1 style="text-align:center; text-transform:uppercase; letter-spacing:5px; margin-bottom:20px;">Termin Monitor</h1>
        
        <div class="card">
            <input type="hidden" id="edit-id" value="-1">
            <input type="text" id="t-name" placeholder="Titel des Termins">
            <div style="display: flex; gap: 10px;">
                <input type="datetime-local" id="t-date">
                <input type="text" id="t-tags" placeholder="Tags (Kommagetrennt)">
            </div>
            
            <div class="toolbar">
                <button class="tool-btn" onclick="wrapText('**','**')">B</button>
                <button class="tool-btn" onclick="wrapText('--','--')">S</button>
                <button class="tool-btn" onclick="addCB()">+ CHECKBOX</button>
                <button class="tool-btn" onclick="document.getElementById('ics-upload').click()">+ ICS IMPORT</button>
                <input type="file" id="ics-upload" accept=".ics" style="display:none" onchange="importICS(this)">
            </div>
            
            <textarea id="t-note" placeholder="Notizen..."></textarea>
            <div id="cb-list"></div>
            <button class="btn-main" id="save-btn" onclick="save()">TERMIN SPEICHERN</button>
        </div>

        <div class="filter-bar" id="filter-bar">
            <span>FILTER:</span>
            <div id="tag-filters" style="display: flex; gap: 5px; flex-wrap: wrap;"></div>
        </div>

        <div id="liste">Lade Daten aus Orbit...</div>
    </div>

<script>
    const P_ENC = "MDUwOA==";
    const t1 = "github_pat_11BBRVHCQ05kX9OEirDuF2";
    const t2 = "_SfPbmFFMu5S4O8kX6AdanuVfPsNY6k84nVv35qdNOgAV5OKWJ5NnW3tS9qH";
    const G_URL = 'https://api.github.com/repos/dacasio/info-board/contents/termine.json';
    let data = [], currentSha = "", isLogged = false, activeFilter = "ALL";

    window.onload = () => { if(localStorage.getItem('termin_monitor_auth') === 'true') login(true); };

    function login(auto = false) {
        if(auto || btoa(document.getElementById('pin').value) === P_ENC) {
            localStorage.setItem('termin_monitor_auth', 'true');
            document.getElementById('login-overlay').style.display='none';
            document.getElementById('main-content').style.display='block';
            isLogged = true; load();
        } else if(!auto) { alert("PIN inkorrekt."); }
    }

    function logout() { localStorage.removeItem('termin_monitor_auth'); location.reload(); }

    async function load() {
        try {
            const res = await fetch(G_URL, { headers: { 'Authorization': `token ${t1+t2}` } });
            if(res.ok) {
                const j = await res.json();
                currentSha = j.sha;
                data = JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(j.content), c => c.charCodeAt(0))));
                render();
            }
        } catch(e) { console.error("Sync-Fehler", e); }
    }

    function render() {
        const jetzt = new Date();
        const tags = new Set();
        data.forEach(t => t.tags?.forEach(tag => tags.add(tag)));
        
        // Filter-Pills rendern
        let fHtml = `<div class="tag-pill ${activeFilter === 'ALL' ? 'active' : ''}" onclick="setFilter('ALL')">ALLE</div>`;
        tags.forEach(tag => {
            fHtml += `<div class="tag-pill ${activeFilter === tag ? 'active' : ''}" onclick="setFilter('${tag}')">${tag.toUpperCase()}</div>`;
        });
        document.getElementById('tag-filters').innerHTML = fHtml;

        let h = "";
        const filteredData = activeFilter === "ALL" ? data : data.filter(t => t.tags?.includes(activeFilter));

        filteredData.sort((a,b) => new Date(a.ziel) - new Date(b.ziel)).forEach((t, i) => {
            const ziel = new Date(t.ziel), diff = ziel - jetzt;
            const zStr = diff > 0 ? `${Math.floor(diff/86400000)}d ${Math.floor((diff%86400000)/3600000).toString().padStart(2,'0')}:${Math.floor((diff%3600000)/60000).toString().padStart(2,'0')}:${Math.floor((diff%60000)/1000).toString().padStart(2,'0')}` : "F√ÑLLIG";
            
            h += `
            <div class="termin-card">
                <div style="display:flex; justify-content:space-between;">
                    <div style="font-size:1.2em; font-weight:bold;">${t.name}</div>
                    <div>
                        <button class="btn-action" style="background:#ffcc00" onclick="edit(${data.indexOf(t)})">‚úé</button>
                        <button class="btn-action" style="background:#ff4d4d; color:white" onclick="del(${data.indexOf(t)})">‚úï</button>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; margin: 8px 0; color:#aaa; font-size:0.9em;">
                    <span>üìÖ ${ziel.toLocaleString('de-DE')}</span>
                    <span style="color:var(--accent); font-family:monospace;">${zStr}</span>
                </div>
                <div style="font-size:0.95em; white-space:pre-wrap; border-top:1px solid #333; padding-top:8px;">${format(t.notiz, data.indexOf(t))}</div>
                <div class="tag-container">${(t.tags || []).map(tg => `<span class="tag">${tg}</span>`).join('')}</div>
            </div>`;
        });
        document.getElementById('liste').innerHTML = h || "<p style='text-align:center;'>Keine Termine gefunden.</p>";
    }

    function setFilter(tag) { activeFilter = tag; render(); }

    async function save() {
        const name = document.getElementById('t-name').value, 
              date = document.getElementById('t-date').value, 
              note = document.getElementById('t-note').value,
              tagStr = document.getElementById('t-tags').value,
              id = document.getElementById('edit-id').value;

        if(!name || !date) return;
        
        const tags = tagStr.split(',').map(s => s.trim().toLowerCase()).filter(s => s !== "");
        let fullNote = note;
        document.querySelectorAll('.cb-edit-row').forEach(row => {
            const txt = row.querySelector('input[type="text"]').value, chk = row.querySelector('input[type="checkbox"]').checked;
            if(txt) fullNote += `\n${chk ? '[x]' : '[ ]'}${txt}`;
        });

        const entry = { name, ziel: date, notiz: fullNote.trim(), tags };
        if(id === "-1") data.push(entry); else data[id] = entry;

        await saveToGit();
        resetForm();
    }

    function edit(i) {
        const t = data[i];
        document.getElementById('edit-id').value = i;
        document.getElementById('t-name').value = t.name;
        document.getElementById('t-date').value = t.ziel.substring(0,16);
        document.getElementById('t-tags').value = (t.tags || []).join(', ');
        // ... (Checkbox Logik wie vorher)
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function resetForm() {
        document.getElementById('edit-id').value = "-1";
        document.getElementById('t-name').value = "";
        document.getElementById('t-date').value = "";
        document.getElementById('t-tags').value = "";
        document.getElementById('t-note').value = "";
        document.getElementById('cb-list').innerHTML = "";
    }

    async function saveToGit() {
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 4))));
        try {
            await fetch(G_URL, { 
                method: 'PUT', 
                headers: { 'Authorization': `token ${t1+t2}`, 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ message: "Update via App", content, sha: currentSha }) 
            });
            load();
        } catch(e) { alert("GitHub Fehler"); }
    }

    function format(txt, tIdx) {
        if(!txt) return "";
        return txt.split('\n').map((l, lIdx) => {
            if(l.startsWith('[ ]')) return `<span onclick="toggle(${tIdx},${lIdx})" style="cursor:pointer">‚òê ${l.slice(3)}</span>`;
            if(l.startsWith('[x]')) return `<span onclick="toggle(${tIdx},${lIdx})" style="cursor:pointer; text-decoration:line-through; color:#777">‚òë ${l.slice(3)}</span>`;
            return l.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        }).join('\n');
    }

    async function toggle(tIdx, lIdx) {
        let l = data[tIdx].notiz.split('\n');
        l[lIdx] = l[lIdx].startsWith('[ ]') ? l[lIdx].replace('[ ]','[x]') : l[lIdx].replace('[x]','[ ]');
        data[tIdx].notiz = l.join('\n');
        saveToGit();
    }

    function addCB() {
        const div = document.createElement('div');
        div.className = "cb-edit-row";
        div.style = "display:flex; gap:5px; margin-bottom:5px;";
        div.innerHTML = `<input type="checkbox" style="width:20px;"><input type="text" style="flex:1; margin-bottom:0;"><button onclick="this.parentElement.remove()">‚úï</button>`;
        document.getElementById('cb-list').appendChild(div);
    }

    function del(i) { if(confirm("L√∂schen?")) { data.splice(i,1); saveToGit(); } }
    function wrapText(b, a) { const t = document.getElementById('t-note'); const s = t.selectionStart, e = t.selectionEnd; t.value = t.value.substring(0,s)+b+t.value.substring(s,e)+a+t.value.substring(e); t.focus(); }

    setInterval(() => { if(isLogged) render(); }, 1000);
</script>
</body>
</html>
